<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>MSE tests</title>
    </head>
    <body>
        <h1>MSE tests</h1>
        <ul>
            <li id="aac-aac">
                <h2>AAC inside of a MP4 container</h2>
                <audio controls></audio>
                <ul class="console"></ul>
            </li>
            <li id="mp2t-mp3">
                <h2>MP3 inside of a MPEG-TS container</h2>
                <audio controls></audio>
                <ul class="console"></ul>
            </li>
            <pre>
                <code>
ffmpeg -f lavfi -i "sine=frequency=1000:duration=5" audio.wav
lame audio.wav audio.mp3
ffmpeg -i audio.mp3 -c:a copy audio.ts
                </code>
            </pre>
            <li id="mp4-aac">
                <h2>AAC inside of a MP4 container</h2>
                <audio controls></audio>
                <ul class="console"></ul>
            </li>
            <pre>
                <code>
ffmpeg -f lavfi -i "sine=frequency=1000:duration=5" audio.wav
ffmpeg -i audio.wav -strict experimental audio.mp4
mp4box -dash 10000 -frag 10000 -rap audio.mp4
                </code>
            </pre>
            <li id="mp4-mp3">
                <h2>MP3 inside of a MP4 container</h2>
                <audio controls></audio>
                <ul class="console"></ul>
            </li>
            <pre>
                <code>
ffmpeg -f lavfi -i "sine=frequency=1000:duration=5" audio.wav
lame audio.wav audio.mp3
mp4box -add audio.mp3#audio audio.m4a
mp4box -dash 10000 -frag 10000 -rap audio.m4a
                </code>
            </pre>
            <li id="webm-opus">
                <h2>Opus inside of a WebM container</h2>
                <audio controls></audio>
                <ul class="console"></ul>
            </li>
            <pre>
                <code>
ffmpeg -f lavfi -i "sine=frequency=1000:duration=5" audio.wav
opusenc audio.wav audio.opus
ffmpeg -i audio.opus -c:a copy -strict experimental audio.webm
                </code>
            </pre>
        </ul>
        <script>
            'use strict';

            function load (file, callback) {
                var xmlHttpRequest = new XMLHttpRequest();

                xmlHttpRequest.open('GET', file);
                xmlHttpRequest.responseType = 'arraybuffer';

                xmlHttpRequest.onerror = function (event) {
                    callback(event);
                };
                xmlHttpRequest.onload = function () {
                    callback(null, xmlHttpRequest.response);
                };

                xmlHttpRequest.send();
            }

            function log (id, message) {
                var cnsl = document.querySelector('#' + id + ' .console'),
                    item = document.createElement('li');

                item.textContent = message;

                cnsl.appendChild(item);
            }

            function setup (mimeType, codec, file, mimeTypeWithCodec) {
                var audioElement,
                    id,
                    mediaSource;

                id = mimeType.split(/\//)[1] + '-' + codec.toLowerCase();

                if (MediaSource.isTypeSupported(mimeTypeWithCodec)) {
                    log(id, 'Audio of type "' + mimeType + '" with ' + codec + ' as a codec seems to be supported.');
                } else {
                    log(id, 'Audio of type "' + mimeType + '" with ' + codec + ' as a codec seems to be NOT supported.');
                }

                audioElement = document.querySelector('#' + id + ' audio');
                mediaSource = new MediaSource();

                audioElement.src = URL.createObjectURL(mediaSource);

                mediaSource.addEventListener('error', function () {
                    log(id, 'An "error" event was fired by the MediaSource.');
                });
                mediaSource.addEventListener('sourceclose', function () {
                    log(id, 'The "sourceclose" event of the MediaSource was fired.');
                });
                mediaSource.addEventListener('sourceended', function () {
                    log(id, 'The "sourceended" event of the MediaSource was fired.');
                });
                mediaSource.addEventListener('sourceopen', function () {
                    var sourceBuffer;

                    log(id, 'The "sourceopen" event of the MediaSource was fired.');

                    try {
                        sourceBuffer = mediaSource.addSourceBuffer(mimeTypeWithCodec);

                        sourceBuffer.addEventListener('abort', function () {
                            log(id, 'The "abort" event of the SourceBuffer was fired.');
                        });
                        sourceBuffer.addEventListener('error', function () {
                            log(id, 'The "error" event of the SourceBuffer was fired.');
                        });
                        sourceBuffer.addEventListener('updateend', function () {
                            log(id, 'The "updateend" event of the SourceBuffer was fired.');
                            log(id, 'Calling "endOfStream()" on the MediaSource.');

                            mediaSource.endOfStream();
                        });

                        load(file, function (err, buffer) {
                            if (err === null) {
                                log(id, 'The buffer of the file "' + file + '" was loaded successfully.');

                                sourceBuffer.appendBuffer(buffer);
                            } else {
                                log(id, 'The file "' + file + '" could not be loaded.');
                            }
                        });
                    } catch (err) {
                        console.error(err);

                        log(id, 'Creating a SourceBuffer of type "' + mimeType + '" with ' + codec + ' as a codec failed. The original error was logged to the console.');
                    }
                });
            }

            setup('audio/aac', 'AAC', 'audio-aac.acc', 'audio/acc; codecs="mp4a.40.2"');

            setup('audio/mp2t', 'MP3', 'audio.ts', 'audio/mp2t');

            setup('audio/mp4', 'AAC', 'audio-aac.mp4', 'audio/mp4; codecs="mp4a.40.2"');

            setup('audio/mp4', 'MP3', 'audio-mp3.mp4', 'audio/mp4');

            setup('audio/webm', 'Opus', 'audio.webm', 'audio/webm; codecs="opus"');
        </script>
    </body>
</html>
